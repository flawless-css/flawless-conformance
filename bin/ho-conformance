#!/usr/bin/env node

var fs = require( 'fs' )
var path = require( 'path' )
var argv = require( 'minimist' )( process.argv.slice( 2 ) )
var Conformance = require( '../dist' )

var DebugTask = require( 'ho-conformance-debug' )
var IDTask = require( 'ho-conformance-id' )


/**
 * @param -e less entry point
 * @param -p less import paths
 * @param --compile punts out parsed output
 * @param -s suppresses streaming of input data
 *
 * e.g.
 * `./bin/ho-conformance --compile < ./spec/junk.less
 * punts out compiled output when ready
 *
 * `./bin/ho-conformance -s -e ./spec/junk.less`
 * suppresses stdout, more useful for general running as it allows console logging
 */


// Conformance options
var entry = argv.e || 'input'
var paths = [
    './node_modules'
]
if ( argv.e ) {
    paths.push( path.dirname( argv.e ) )
}
if ( argv.p ) {
    argv.p.split( ',' ).forEach( function( importPath ) {
        paths.push( importPath )
    })
}


var conformance = new Conformance({
    paths: paths,
    entry: entry,
    streaming: !argv.s,
    compiling: argv.compile
})

conformance.on( 'error', function( err ) {
    console.error( err )
})

// conformance.register( new DebugTask() )
// conformance.register( new IDTask() )

// Stream through conformance
var stream = argv.e ? fs.createReadStream( argv.e ) : process.stdin
stream.pipe( conformance ).pipe( process.stdout )
